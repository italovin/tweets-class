@page "/questions"
@using blazor_test.Repositories
@using blazor_test.Models
@using blazor_test.Features.Questions.Components
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage ProtectedSessionStore
@attribute [StreamRendering(true)]
@rendermode @(new InteractiveServerRenderMode(false))

@inject PhraseRepository PhraseRepository

<PageTitle>Quest√µes</PageTitle>

@if(questionsState == (int)QuestionsStateEnum.Presentation){
    <QuestionsPresentation @bind-QuestionsState="questionsState" @bind-AccessKeyId="accessKeyId"></QuestionsPresentation>
} else if (questionsState == (int)QuestionsStateEnum.Respond){
    <QuestionForm @bind-QuestionsState="questionsState" Phrases="@phrases" @bind-LabelingsResponse="labelingsResponse">
    </QuestionForm>
} else if (questionsState == (int)QuestionsStateEnum.Revision){
    <QuestionsRevision @bind-QuestionsState="questionsState" AccessKeyId="@accessKeyId" Phrases="@phrases" LabelingsResponse="@labelingsResponse"></QuestionsRevision>
} else if (questionsState == (int)QuestionsStateEnum.Concluded){
    <QuestionsConcluded></QuestionsConcluded>      
}

@code{
    private readonly int questionsToRespond = 15;
    private int questionsState = (int)QuestionsStateEnum.Presentation;
    private List<Phrase> phrases = new();
    private List<Labeling> labelingsResponse = new();

    private int accessKeyId = 0;

    protected override async Task OnInitializedAsync(){
        var result = await ProtectedSessionStore.GetAsync<List<Phrase>>("phrases");
        if(result.Value is not null){
            phrases = result.Value;
        } else {
            phrases = await PhraseRepository.GetPhrases(questionsToRespond);
            await ProtectedSessionStore.SetAsync("phrases", phrases);
        }
    }

}